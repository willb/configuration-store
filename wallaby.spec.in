%{!?ruby_sitelib: %global ruby_sitelib %(ruby -rrbconfig -e 'puts Config::CONFIG["sitelibdir"] ')}
%define rel 1

Summary: Configuration store via QMF
Name: wallaby
Version: WALLABY_VERSION
Release: %{rel}%{?dist}
Group: Applications/System
License: ASL 2.0
URL: http://git.fedorahosted.org/git/grid/wallaby.git
Source0: %{name}-%{version}-%{rel}.tar.gz
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
Requires: ruby(abi) = 1.8
Requires: ruby
Requires: ruby-spqr >= 0.3.0
Requires: ruby-rhubarb >= 0.2.6
Requires: ruby-qmf >= 0.7.929717
Requires: ruby-wallaby = %{version}-%{release}
Requires(post): chkconfig
Requires(preun): chkconfig
Requires(preun): initscripts
Requires(postun): initscripts
BuildArch: noarch

%description
A QMF accessible configuration store.

%package utils
Summary: Configuration store utilities
Group: Applications/System
Requires: ruby(abi) = 1.8
Requires: ruby
Requires: ruby-qmf >= 0.7.929717
Requires: ruby-wallaby

%description utils
Utilities for interacting with wallaby

%package -n ruby-wallaby
Summary: wallaby qmf api methods
Group: Applications/System
Requires: ruby(abi) = 1.8
Requires: ruby
Requires: ruby-qmf >= 0.7.929717
BuildRequires: ruby

%description -n ruby-wallaby
Functions to communicate with wallaby over qmf

%prep
%setup -q

%build

%install
rm -rf %{buildroot}
mkdir -p %{buildroot}/%{ruby_sitelib}/mrg/grid/config/dbmigrate
mkdir -p %{buildroot}/%{ruby_sitelib}/mrg/grid/config/shell
mkdir -p %{buildroot}/%{ruby_sitelib}/mrg/grid/util
mkdir -p %{buildroot}/%{_bindir}
mkdir -p %{buildroot}/%{_localstatedir}/lib/wallaby
mkdir -p %{buildroot}/%{_initrddir}
mkdir -p %{buildroot}/%{_sysconfdir}
mkdir -p %{buildroot}/%{_sysconfdir}/sysconfig
mkdir -p %{buildroot}/%{_localstatedir}/log/wallaby
cp -f bin/wallaby %{buildroot}/%{_bindir}
cp -f bin/wallaby-dump %{buildroot}/%{_bindir}
cp -f bin/wallaby-load %{buildroot}/%{_bindir}
cp -f bin/wallaby-inventory %{buildroot}/%{_bindir}
cp -f bin/wallaby-feature-import %{buildroot}/%{_bindir}
cp -f bin/wallaby-activate %{buildroot}/%{_bindir}
cp -f bin/wallaby-agent %{buildroot}/%{_bindir}
cp -f lib/mrg/grid/*.rb %{buildroot}/%{ruby_sitelib}/mrg/grid
cp -f lib/mrg/grid/util/*.rb %{buildroot}/%{ruby_sitelib}/mrg/grid/util
cp -f lib/mrg/grid/config/*.rb %{buildroot}/%{ruby_sitelib}/mrg/grid/config
cp -f lib/mrg/grid/config/shell/*.rb %{buildroot}/%{ruby_sitelib}/mrg/grid/config/shell
cp -f lib/mrg/grid/config/dbmigrate/*.rb %{buildroot}/%{ruby_sitelib}/mrg/grid/config/dbmigrate
cp -f etc/wallaby %{buildroot}/%{_initrddir}/wallaby
cp -f etc/sysconfig/wallaby-agent %{buildroot}/%{_sysconfdir}/sysconfig/wallaby-agent

%clean
rm -rf %{buildroot}

%files
%defattr(-, root, root, -)
%doc LICENSE README.rdoc TODO VERSION
%defattr(0755,wallaby,wallaby,-)
%dir %{_localstatedir}/lib/wallaby
%dir %{_localstatedir}/log/wallaby
%defattr(0755,root,root,-)
%{_bindir}/wallaby-agent
%{_initrddir}/wallaby
%config(noreplace) %{_sysconfdir}/sysconfig/wallaby-agent

%pre
getent group wallaby >/dev/null || groupadd -r wallaby
getent passwd wallaby >/dev/null || \
  useradd -r -g condor -d %{_localstatedir}/lib/wallaby -s /sbin/nologin \
    -c "Owner of Wallaby service" wallaby

%post
# This adds the proper /etc/rc*.d links for the script
/sbin/chkconfig --add wallaby

%preun
if [ $1 = 0 ] ; then
    /sbin/service wallaby stop >/dev/null 2>&1
    /sbin/chkconfig --del wallaby
fi

%postun
if [ "$1" -ge "1" ] ; then
    chown -R wallaby:wallaby /var/lib/wallaby /var/log/wallaby
    /sbin/service wallaby condrestart >/dev/null 2>&1 || :
fi

%files utils
%defattr(-, root, root, -)
%doc LICENSE
%defattr(0755,root,root,-)
%{_bindir}/wallaby
%{_bindir}/wallaby-load
%{_bindir}/wallaby-dump
%{_bindir}/wallaby-inventory
%{_bindir}/wallaby-activate
%{_bindir}/wallaby-feature-import

%files -n ruby-wallaby
%defattr(-, root, root, -)
%{ruby_sitelib}/mrg/grid/config.rb
%{ruby_sitelib}/mrg/grid/config-client.rb
%{ruby_sitelib}/mrg/grid/config-proxies.rb
%{ruby_sitelib}/mrg/grid/config/ArcLabel.rb
%{ruby_sitelib}/mrg/grid/config/ArcUtils.rb
%{ruby_sitelib}/mrg/grid/config/Configuration.rb
%{ruby_sitelib}/mrg/grid/config/ConfigValidating.rb
%{ruby_sitelib}/mrg/grid/config/DirtyElement.rb
%{ruby_sitelib}/mrg/grid/config/DataValidating.rb
%{ruby_sitelib}/mrg/grid/config/Feature.rb
%{ruby_sitelib}/mrg/grid/config/Group.rb
%{ruby_sitelib}/mrg/grid/config/InconsistencyDetecting.rb
%{ruby_sitelib}/mrg/grid/config/Node.rb
%{ruby_sitelib}/mrg/grid/config/NodeMembership.rb
%{ruby_sitelib}/mrg/grid/config/Parameter.rb
%{ruby_sitelib}/mrg/grid/config/QmfUtils.rb
%{ruby_sitelib}/mrg/grid/config/Snapshot.rb
%{ruby_sitelib}/mrg/grid/config/Store.rb
%{ruby_sitelib}/mrg/grid/config/Subsystem.rb
%{ruby_sitelib}/mrg/grid/config/dbmeta.rb
%{ruby_sitelib}/mrg/grid/config/errors.rb
%{ruby_sitelib}/mrg/grid/config/dbmigrate/1.rb
%{ruby_sitelib}/mrg/grid/config/dbmigrate/2.rb
%{ruby_sitelib}/mrg/grid/config/dbmigrate/3.rb
%{ruby_sitelib}/mrg/grid/config/dbmigrate/4.rb
%{ruby_sitelib}/mrg/grid/config/dbmigrate/5.rb
%{ruby_sitelib}/mrg/grid/util/graph.rb
%{ruby_sitelib}/mrg/grid/config/shell.rb
%{ruby_sitelib}/mrg/grid/config/shell/add_param.rb
%{ruby_sitelib}/mrg/grid/config/shell/apropos.rb
%{ruby_sitelib}/mrg/grid/config/shell/snapshot.rb


%changelog


* Tue Aug 3 2010 willb <willb@redhat> - 0.9.1-1
- Updated to source version 0.9.1

* Mon Aug 2 2010 willb <willb@redhat> - 0.9.0-1
- Updated to source version 0.9.0

* Tue Jul 27 2010 willb <willb@redhat> - 0.6.3-1
- Updated to source version 0.6.3

* Fri Jun 25 2010 willb <willb@redhat> - 0.6.2-1
- Updated to source version 0.6.2

* Fri Jun 25 2010 rrati <rrati@redhat> - 0.6.1-2
- Packaging fixes

* Fri Jun 25 2010 rrati <rrati@redhat> - 0.6.1-1
- Updated to source version 0.6.1

* Wed Jun 23 2010 willb <willb@redhat> - 0.6.0-1
- Updated to source version 0.6.0
- Init script fixes

* Fri Jun 11 2010 willb <willb@redhat> - 0.5.1-1
- Updated to source version 0.5.1

* Fri Jun 11 2010 willb <willb@redhat> - 0.5.0-1
- Updated to source version 0.5.0

* Thu Jun 10 2010 willb <willb@redhat> - 0.4.2-1
- Updated to source version 0.4.2

* Thu Jun 10 2010 willb <willb@redhat> - 0.4.1-1
- Updated to source version 0.4.1

* Thu Jun 10 2010 willb <willb@redhat> - 0.4.0-1
- Updated to source version 0.4.0

* Wed May 26 2010 willb <willb@redhat> - 0.3.5-2
- Packaging and initscript fixes

* Fri May 21 2010 willb <willb@redhat> - 0.3.5-1
- Updated to source version 0.3.5

* Tue Apr 20 2010 willb <willb@redhat> - 0.3.2-1
- Updated to source version 0.3.2

* Mon Apr 12 2010 willb <willb@redhat> - 0.3.1-1
- Updated to source version 0.3.1

* Fri Apr 9 2010 willb <willb@redhat> - 0.3.0-1
- Updated to source version 0.3.0

* Tue Mar 30 2010 willb <willb@redhat> - 0.2.12-1
- Updated to source version 0.2.12

* Thu Mar 25 2010 willb <willb@redhat> - 0.2.11-1
- Updated to source version 0.2.11

* Tue Mar 9 2010 willb <willb@redhat> - 0.2.10-1
- Updated to source version 0.2.10

* Fri Mar 5 2010 willb <willb@redhat> - 0.2.9-1
- Updated to source version 0.2.9

* Thu Mar 4 2010 willb <willb@redhat> - 0.2.8-1.0
- Updated to source version 0.2.8

* Fri Feb 27 2010 willb <willb@redhat> - 0.2.7-1.0
- Updated to source version 0.2.7

* Thu Feb 26 2010 willb <willb@redhat> - 0.2.6-1.0
- Updated to source version 0.2.6

* Wed Feb 25 2010 willb <willb@redhat> - 0.2.5-1.0
- Updated to source version 0.2.5

* Wed Feb 25 2010 willb <willb@redhat> - 0.2.4-1.0
- Updated to source version 0.2.4

* Tue Feb 23 2010 willb <willb@redhat> - 0.2.3-1.0
- Updated to source version 0.2.3

* Tue Feb 23 2010 rrati <rrati@redhat> - 0.2.2-1.0
- Updated to source version 0.2.2

* Tue Feb 23 2010 rrati <rrati@redhat> - 0.2.1-1.0
- Updated to source version 0.2.1

* Fri Feb 19 2010 willb <willb@redhat> - 0.2.0-1.0
- Event functionality
- Configuration activation
- wallaby-activate tool

* Wed Feb 10 2010 rrati <rrati@redhat> - 0.1.0-0.1
- Initial package
